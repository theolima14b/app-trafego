import { useState, useCallback, useMemo } from 'react'

export default function CampaignAnalysis() {
  const [csvData, setCsvData] = useState(null)
  const [headers, setHeaders] = useState([])
  const [rows, setRows] = useState([])
  const [dragActive, setDragActive] = useState(false)
  const [fileName, setFileName] = useState('')
  const [searchTerm, setSearchTerm] = useState('')
  const [currentPage, setCurrentPage] = useState(1)
  const [selectedRow, setSelectedRow] = useState(null)
  const rowsPerPage = 15

  // Parse CSV file
  const parseCSV = (text) => {
    const lines = text.split('\n').filter(line => line.trim())
    if (lines.length === 0) return { headers: [], rows: [] }

    const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''))
    const rows = lines.slice(1).map(line => {
      const values = line.split(',').map(v => v.trim().replace(/^"|"$/g, ''))
      return headers.reduce((obj, header, index) => {
        obj[header] = values[index] || ''
        return obj
      }, {})
    })

    return { headers, rows }
  }

  // Handle file upload
  const handleFile = useCallback((file) => {
    if (!file) return
    setFileName(file.name)

    const reader = new FileReader()
    reader.onload = (e) => {
      const text = e.target.result
      const { headers, rows } = parseCSV(text)
      setHeaders(headers)
      setRows(rows)
      setCsvData({ headers, rows })
      setSearchTerm('')
      setCurrentPage(1)
    }
    reader.readAsText(file)
  }, [])

  // Drag and drop handlers
  const handleDrag = (e) => {
    e.preventDefault()
    e.stopPropagation()
    if (e.type === 'dragenter' || e.type === 'dragover') {
      setDragActive(true)
    } else if (e.type === 'dragleave') {
      setDragActive(false)
    }
  }

  const handleDrop = (e) => {
    e.preventDefault()
    e.stopPropagation()
    setDragActive(false)
    
    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
      handleFile(e.dataTransfer.files[0])
    }
  }

  const handleChange = (e) => {
    e.preventDefault()
    if (e.target.files && e.target.files[0]) {
      handleFile(e.target.files[0])
    }
  }

  // Reset and clear data
  const handleReset = () => {
    setCsvData(null)
    setHeaders([])
    setRows([])
    setFileName('')
    setSearchTerm('')
    setCurrentPage(1)
    setSelectedRow(null)
  }

  // Detect column types (numeric, date, text)
  const columnTypes = useMemo(() => {
    if (!rows.length || !headers.length) return {}
    
    const types = {}
    headers.forEach(header => {
      const sample = rows.slice(0, 10).map(row => row[header]).filter(v => v && String(v).trim())
      
      if (sample.length === 0) {
        types[header] = 'text'
        return
      }
      
      // Check if it's a date
      const datePattern = /^\d{1,4}[-\/]\d{1,2}[-\/]\d{1,4}$/
      const isDate = sample.every(v => datePattern.test(String(v).trim()))
      
      if (isDate) {
        types[header] = 'date'
        return
      }
      
      // Check if it's numeric
      const numericValues = sample.map(v => parseFloat(String(v).replace(',', '.'))).filter(v => !isNaN(v))
      if (numericValues.length === sample.length) {
        types[header] = 'numeric'
        return
      }
      
      types[header] = 'text'
    })
    
    return types
  }, [rows, headers])

  // Calculate statistics only for numeric columns
  const statistics = useMemo(() => {
    if (!rows.length) return {}
    
    const stats = {}
    headers.forEach(header => {
      if (columnTypes[header] !== 'numeric') return
      
      const values = rows.map(row => {
        const val = String(row[header]).replace(',', '.')
        return parseFloat(val)
      }).filter(v => !isNaN(v))
      
      if (values.length > 0) {
        const sum = values.reduce((a, b) => a + b, 0)
        stats[header] = {
          count: values.length,
          sum: sum,
          avg: sum / values.length,
          min: Math.min(...values),
          max: Math.max(...values)
        }
      }
    })
    return stats
  }, [rows, headers, columnTypes])

  // Group data by a column for separate analysis
  const [groupByColumn, setGroupByColumn] = useState('')
  const [selectedGroup, setSelectedGroup] = useState('')

  const groupedData = useMemo(() => {
    if (!groupByColumn || !rows.length) return {}
    
    const groups = {}
    rows.forEach(row => {
      const groupValue = row[groupByColumn] || 'Sem valor'
      if (!groups[groupValue]) {
        groups[groupValue] = []
      }
      groups[groupValue].push(row)
    })
    return groups
  }, [rows, groupByColumn])

  const displayRows = useMemo(() => {
    if (!groupByColumn || !selectedGroup) return rows
    return groupedData[selectedGroup] || []
  }, [rows, groupByColumn, selectedGroup, groupedData])

  // Filter rows based on search
  const filteredRows = useMemo(() => {
    if (!searchTerm.trim()) return displayRows
    
    const term = searchTerm.toLowerCase()
    return displayRows.filter(row => 
      Object.values(row).some(value => 
        String(value).toLowerCase().includes(term)
      )
    )
  }, [displayRows, searchTerm])

  // Pagination
  const totalPages = Math.ceil(filteredRows.length / rowsPerPage)
  const paginatedRows = useMemo(() => {
    const start = (currentPage - 1) * rowsPerPage
    return filteredRows.slice(start, start + rowsPerPage)
  }, [filteredRows, currentPage, rowsPerPage])

  return (
    <div className="max-w-[1400px] w-full mx-auto">
      {!selectedRow ? (
        <div>
          <div className="mb-6">
            <h1 className="text-2xl font-bold text-gray-900 mb-2">An√°lise de Campanha</h1>
            <p className="text-sm text-gray-600">Fa√ßa upload de um arquivo CSV e selecione uma linha para visualizar o dashboard de performance</p>
          </div>

          {!csvData ? (
        <div
          className={`border-2 border-dashed rounded-xl p-12 text-center transition-all ${
            dragActive 
              ? 'border-blue-500 bg-blue-50' 
              : 'border-gray-300 bg-white hover:border-gray-400'
          }`}
          onDragEnter={handleDrag}
          onDragLeave={handleDrag}
          onDragOver={handleDrag}
          onDrop={handleDrop}
        >
          <svg className="mx-auto h-12 w-12 text-gray-400 mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48">
            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
          </svg>
          <div className="flex text-sm text-gray-600 justify-center mb-2">
            <label htmlFor="file-upload" className="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500">
              <span>Selecione um arquivo</span>
              <input 
                id="file-upload" 
                name="file-upload" 
                type="file" 
                className="sr-only" 
                accept=".csv"
                onChange={handleChange}
              />
            </label>
            <p className="pl-1">ou arraste aqui</p>
          </div>
          <p className="text-xs text-gray-500">CSV at√© 10MB</p>
        </div>
      ) : (
        <div className="space-y-6">
          {/* File info and reset */}
          <div className="bg-white p-4 rounded-lg border border-gray-200 flex items-center justify-between shadow-sm">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-green-50 rounded-lg">
                <svg className="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
              </div>
              <div>
                <p className="text-sm font-semibold text-gray-900">{fileName}</p>
                <p className="text-xs text-gray-500">{headers.length} colunas ‚Ä¢ {rows.length} linhas</p>
              </div>
            </div>
            <button 
              onClick={handleReset}
              className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:border-gray-400 transition-all"
            >
              Trocar arquivo
            </button>
          </div>

          {/* Summary Statistics */}
          {Object.keys(statistics).length > 0 && (
            <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
              {Object.entries(statistics).slice(0, 5).map(([column, stats]) => (
                <div key={column} className="bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200 shadow-sm">
                  <p className="text-xs font-medium text-gray-600 uppercase tracking-wide mb-2">{column}</p>
                  <div className="space-y-1">
                    <div className="flex justify-between text-xs">
                      <span className="text-gray-600">Total:</span>
                      <span className="font-semibold text-gray-900">{stats.sum.toLocaleString('pt-BR', { maximumFractionDigits: 2 })}</span>
                    </div>
                    <div className="flex justify-between text-xs">
                      <span className="text-gray-600">M√©dia:</span>
                      <span className="font-semibold text-gray-900">{stats.avg.toLocaleString('pt-BR', { maximumFractionDigits: 2 })}</span>
                    </div>
                    <div className="flex justify-between text-xs">
                      <span className="text-gray-600">Min/Max:</span>
                      <span className="font-semibold text-gray-900">{stats.min} / {stats.max}</span>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}

          {/* Group by selector */}
          <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
            <div className="flex flex-col md:flex-row gap-4">
              <div className="flex-1">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Agrupar e analisar separadamente por:
                </label>
                <select
                  value={groupByColumn}
                  onChange={(e) => {
                    setGroupByColumn(e.target.value)
                    setSelectedGroup('')
                    setCurrentPage(1)
                  }}
                  className="w-full h-10 px-3 border border-gray-300 rounded-md text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all"
                >
                  <option value="">Visualizar todos os registros</option>
                  {headers.filter(h => columnTypes[h] === 'text' || columnTypes[h] === 'date').map(header => (
                    <option key={header} value={header}>{header}</option>
                  ))}
                </select>
              </div>
              
              {groupByColumn && Object.keys(groupedData).length > 0 && (
                <div className="flex-1">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Selecionar grupo para an√°lise:
                  </label>
                  <select
                    value={selectedGroup}
                    onChange={(e) => {
                      setSelectedGroup(e.target.value)
                      setCurrentPage(1)
                    }}
                    className="w-full h-10 px-3 border border-gray-300 rounded-md text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all"
                  >
                    <option value="">Todos os grupos ({Object.keys(groupedData).length})</option>
                    {Object.entries(groupedData).map(([group, items]) => (
                      <option key={group} value={group}>
                        {group} ({items.length} registros)
                      </option>
                    ))}
                  </select>
                </div>
              )}
            </div>
            
            {groupByColumn && !selectedGroup && (
              <div className="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-md">
                <p className="text-sm text-blue-800">
                  üìä {Object.keys(groupedData).length} grupos detectados. Selecione um para an√°lise detalhada.
                </p>
              </div>
            )}
          </div>

          {/* Search and filters */}
          <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
            <div className="flex items-center gap-3">
              <div className="relative flex-1">
                <input
                  type="text"
                  placeholder="Buscar em todos os campos..."
                  value={searchTerm}
                  onChange={(e) => {
                    setSearchTerm(e.target.value)
                    setCurrentPage(1)
                  }}
                  className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all"
                />
                <svg className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
              <div className="text-sm text-gray-600">
                {filteredRows.length === rows.length ? (
                  <span>{rows.length} registros</span>
                ) : (
                  <span>{filteredRows.length} de {rows.length} registros</span>
                )}
              </div>
            </div>
          </div>

          {/* Data table */}
          <div className="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gradient-to-r from-gray-50 to-gray-100">
                  <tr>
                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider whitespace-nowrap">
                      #
                    </th>
                    {headers.map(header => (
                      <th key={header} className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider whitespace-nowrap">
                        {header}
                      </th>
                    ))}
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-100">
                  {paginatedRows.map((row, idx) => (
                    <tr 
                      key={idx} 
                      onClick={() => setSelectedRow(row)}
                      className="hover:bg-blue-100 transition-colors cursor-pointer"
                    >
                      <td className="px-4 py-3 text-sm text-gray-500 font-medium whitespace-nowrap">
                        {(currentPage - 1) * rowsPerPage + idx + 1}
                      </td>
                      {headers.map(header => (
                        <td key={header} className="px-4 py-3 text-sm text-gray-900 whitespace-nowrap">
                          {row[header] || <span className="text-gray-400">-</span>}
                        </td>
                      ))}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            
            {/* Pagination */}
            {totalPages > 1 && (
              <div className="bg-gray-50 px-4 py-3 flex items-center justify-between border-t border-gray-200">
                <div className="flex-1 flex justify-between sm:hidden">
                  <button
                    onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                    disabled={currentPage === 1}
                    className="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    Anterior
                  </button>
                  <button
                    onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                    disabled={currentPage === totalPages}
                    className="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    Pr√≥xima
                  </button>
                </div>
                <div className="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                  <div>
                    <p className="text-sm text-gray-700">
                      Mostrando <span className="font-medium">{(currentPage - 1) * rowsPerPage + 1}</span> a{' '}
                      <span className="font-medium">{Math.min(currentPage * rowsPerPage, filteredRows.length)}</span> de{' '}
                      <span className="font-medium">{filteredRows.length}</span> resultados
                    </p>
                  </div>
                  <div>
                    <nav className="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                      <button
                        onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                        disabled={currentPage === 1}
                        className="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        <svg className="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                          <path fillRule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clipRule="evenodd" />
                        </svg>
                      </button>
                      {[...Array(Math.min(5, totalPages))].map((_, i) => {
                        let pageNum
                        if (totalPages <= 5) {
                          pageNum = i + 1
                        } else if (currentPage <= 3) {
                          pageNum = i + 1
                        } else if (currentPage >= totalPages - 2) {
                          pageNum = totalPages - 4 + i
                        } else {
                          pageNum = currentPage - 2 + i
                        }
                        return (
                          <button
                            key={pageNum}
                            onClick={() => setCurrentPage(pageNum)}
                            className={`relative inline-flex items-center px-4 py-2 border text-sm font-medium ${
                              currentPage === pageNum
                                ? 'z-10 bg-blue-50 border-blue-500 text-blue-600'
                                : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'
                            }`}
                          >
                            {pageNum}
                          </button>
                        )
                      })}
                      <button
                        onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                        disabled={currentPage === totalPages}
                        className="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        <svg className="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                          <path fillRule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clipRule="evenodd" />
                        </svg>
                      </button>
                    </nav>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      ) : (
        // Dashboard view for selected row
        <div className="space-y-6">
          {/* Header with back button */}
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-bold text-gray-900 mb-1">Dashboard de Performance</h1>
              <p className="text-sm text-gray-600">An√°lise detalhada do registro selecionado</p>
            </div>
            <button
              onClick={() => setSelectedRow(null)}
              className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
            >
              ‚Üê Voltar para lista
            </button>
          </div>

          {/* Metric Cards Grid */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            {headers.map((header, idx) => {
              const value = selectedRow[header]
              const isNumeric = columnTypes[header] === 'numeric'
              const isDate = columnTypes[header] === 'date'
              
              // Choose icon based on field name
              let icon = (
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
              )
              
              if (header.toLowerCase().includes('click')) {
                icon = (
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" />
                  </svg>
                )
              } else if (header.toLowerCase().includes('impress')) {
                icon = (
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                  </svg>
                )
              } else if (header.toLowerCase().includes('convers')) {
                icon = (
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                  </svg>
                )
              } else if (header.toLowerCase().includes('custo') || header.toLowerCase().includes('cost') || header.toLowerCase().includes('invest')) {
                icon = (
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                )
              } else if (header.toLowerCase().includes('receita') || header.toLowerCase().includes('revenue')) {
                icon = (
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                )
              } else if (header.toLowerCase().includes('roas')) {
                icon = (
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                  </svg>
                )
              } else if (header.toLowerCase().includes('ctr') || header.toLowerCase().includes('taxa')) {
                icon = (
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                  </svg>
                )
              }
              
              let displayValue = value || '-'
              if (isNumeric && value) {
                const numValue = parseFloat(String(value).replace(',', '.'))
                if (!isNaN(numValue)) {
                  displayValue = numValue.toLocaleString('pt-BR', { maximumFractionDigits: 2 })
                }
              }
              
              return (
                <div key={idx} className="bg-gray-800 text-white p-5 rounded-lg border border-gray-700 shadow-lg hover:shadow-xl transition-shadow">
                  <div className="flex items-start justify-between mb-3">
                    <p className="text-xs font-medium text-gray-400 uppercase tracking-wide">{header}</p>
                    <div className="text-gray-400">
                      {icon}
                    </div>
                  </div>
                  <p className="text-2xl font-bold">{displayValue}</p>
                </div>
              )
            })}
          </div>

          {/* Insights Section */}
          <div className="bg-gray-800 text-white p-6 rounded-lg border border-gray-700 shadow-lg">
            <h2 className="text-lg font-semibold mb-2">Insights e Recomenda√ß√µes</h2>
            <p className="text-sm text-gray-400 mb-4">An√°lise detalhada do desempenho desta entrada</p>
            
            <div className="space-y-4">
              {/* Calculate basic insights */}
              {(() => {
                const insights = []
                
                // Check for ROAS if exists
                const roasField = headers.find(h => h.toLowerCase().includes('roas'))
                if (roasField && selectedRow[roasField]) {
                  const roas = parseFloat(String(selectedRow[roasField]).replace(',', '.'))
                  if (!isNaN(roas) && roas < 2) {
                    insights.push({
                      type: 'warning',
                      title: 'ROAS Abaixo do Ideal',
                      message: `ROAS de ${roas.toFixed(2)}x est√° abaixo da meta recomendada de 2x.`,
                      actions: [
                        'Revise sua segmenta√ß√£o - pode estar muito ampla',
                        'Teste ofertas mais atrativas ou urg√™ncia (desconto limitado)',
                        'Verifique se a landing page est√° alinhada com o an√∫ncio',
                        'Considere pausar an√∫ncios de baixo desempenho'
                      ]
                    })
                  }
                }
                
                // Check for CTR if exists
                const ctrField = headers.find(h => h.toLowerCase().includes('ctr'))
                if (ctrField && selectedRow[ctrField]) {
                  const ctrValue = String(selectedRow[ctrField]).replace('%', '').replace(',', '.')
                  const ctr = parseFloat(ctrValue)
                  if (!isNaN(ctr) && ctr < 1) {
                    insights.push({
                      type: 'info',
                      title: 'CTR Baixo Detectado',
                      message: `Taxa de cliques de ${ctr.toFixed(2)}% pode ser melhorada.`,
                      actions: [
                        'Teste novos criativos e headlines',
                        'Revise a relev√¢ncia do p√∫blico-alvo',
                        'Adicione call-to-actions mais claros'
                      ]
                    })
                  }
                }
                
                // Check for conversion data
                const convField = headers.find(h => h.toLowerCase().includes('convers'))
                const clickField = headers.find(h => h.toLowerCase().includes('click'))
                if (convField && clickField && selectedRow[convField] && selectedRow[clickField]) {
                  const conv = parseFloat(String(selectedRow[convField]).replace(',', '.'))
                  const clicks = parseFloat(String(selectedRow[clickField]).replace(',', '.'))
                  if (!isNaN(conv) && !isNaN(clicks) && clicks > 0) {
                    const convRate = (conv / clicks) * 100
                    if (convRate < 2) {
                      insights.push({
                        type: 'info',
                        title: 'Taxa de Convers√£o Baixa',
                        message: `${convRate.toFixed(2)}% de convers√£o indica oportunidade de melhoria.`,
                        actions: [
                          'Otimize a experi√™ncia da landing page',
                          'Simplifique o processo de checkout',
                          'Adicione provas sociais e depoimentos'
                        ]
                      })
                    }
                  }
                }
                
                if (insights.length === 0) {
                  insights.push({
                    type: 'success',
                    title: 'Performance Adequada',
                    message: 'Os principais indicadores est√£o dentro dos par√¢metros esperados.',
                    actions: ['Continue monitorando as m√©tricas', 'Considere testes A/B para otimiza√ß√£o']
                  })
                }
                
                return insights.map((insight, idx) => (
                  <div key={idx} className="bg-gray-900 p-4 rounded-md border border-gray-700">
                    <div className="flex items-start gap-2 mb-2">
                      {insight.type === 'warning' && (
                        <svg className="w-5 h-5 text-yellow-500 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                          <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                        </svg>
                      )}
                      <div className="flex-1">
                        <h3 className="text-sm font-semibold text-white mb-1">{insight.title}</h3>
                        <p className="text-sm text-gray-400 mb-3">{insight.message}</p>
                        {insight.actions && insight.actions.length > 0 && (
                          <div>
                            <p className="text-xs font-medium text-gray-500 mb-2">A√ß√µes Urgentes:</p>
                            <ul className="space-y-1">
                              {insight.actions.map((action, i) => (
                                <li key={i} className="text-sm text-gray-300 flex items-start">
                                  <span className="text-gray-500 mr-2">‚Ä¢</span>
                                  <span>{action}</span>
                                </li>
                              ))}
                            </ul>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                ))
              })()}
            </div>
          </div>
        </div>
      )}
    </div>
  )
}
